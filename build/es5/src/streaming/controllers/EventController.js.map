{"version":3,"sources":["../../../../../src/streaming/controllers/EventController.js"],"names":[],"mappings":"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","file":"EventController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport PlaybackController from '../controllers/PlaybackController';\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport EventBus from '../../core/EventBus';\n\nfunction EventController() {\n\n    const MPD_RELOAD_SCHEME = 'urn:mpeg:dash:event:2012';\n    const MPD_RELOAD_VALUE = 1;\n\n    let context = this.context;\n    let log = Debug(context).getInstance().log;\n    let eventBus = EventBus(context).getInstance();\n\n    let instance,\n        inlineEvents, // Holds all Inline Events not triggered yet\n        inbandEvents, // Holds all Inband Events not triggered yet\n        activeEvents, // Holds all Events currently running\n        eventInterval, // variable holding the setInterval\n        refreshDelay, // refreshTime for the setInterval\n        presentationTimeThreshold,\n        manifestModel,\n        manifestUpdater,\n        playbackController,\n        isStarted;\n\n    function initialize() {\n        isStarted = false;\n        inlineEvents = {};\n        inbandEvents = {};\n        activeEvents = {};\n        eventInterval = null;\n        refreshDelay = 100;\n        presentationTimeThreshold = refreshDelay / 1000;\n        playbackController = PlaybackController(context).getInstance();\n    }\n\n    function clear() {\n        if (eventInterval !== null && isStarted) {\n            clearInterval(eventInterval);\n            eventInterval = null;\n            isStarted = false;\n        }\n    }\n\n    function start() {\n        log('Start Event Controller');\n        if (!isStarted && !isNaN(refreshDelay)) {\n            isStarted = true;\n            eventInterval = setInterval(onEventTimer, refreshDelay);\n        }\n    }\n\n    /**\n     * Add events to the eventList. Events that are not in the mpd anymore but not triggered yet will still be deleted\n     * @param {Array.<Object>} values\n     */\n    function addInlineEvents(values) {\n        inlineEvents = {};\n\n        if (values) {\n            for (var i = 0; i < values.length; i++) {\n                var event = values[i];\n                inlineEvents[event.id] = event;\n                log('Add inline event with id ' + event.id);\n            }\n        }\n        log('Added ' + values.length + ' inline events');\n    }\n\n    /**\n     * i.e. processing of any one event message box with the same id is sufficient\n     * @param {Array.<Object>} values\n     */\n    function addInbandEvents(values) {\n        for (var i = 0; i < values.length; i++) {\n            var event = values[i];\n            if (!(event.id in inbandEvents)) {\n                inbandEvents[event.id] = event;\n                log('Add inband event with id ' + event.id);\n            } else {\n                log('Repeated event with id ' + event.id);\n            }\n        }\n    }\n\n    /**\n     * Remove events which are over from the list\n     */\n    function removeEvents() {\n        if (activeEvents) {\n            var currentVideoTime = playbackController.getTime();\n            var eventIds = Object.keys(activeEvents);\n\n            for (var i = 0; i < eventIds.length; i++) {\n                var eventId = eventIds[i];\n                var curr = activeEvents[eventId];\n                if (curr !== null && (curr.duration + curr.presentationTime) / curr.eventStream.timescale < currentVideoTime) {\n                    log('Remove Event ' + eventId + ' at time ' + currentVideoTime);\n                    curr = null;\n                    delete activeEvents[eventId];\n                }\n            }\n        }\n    }\n\n    /**\n     * Iterate through the eventList and trigger/remove the events\n     */\n    function onEventTimer() {\n        triggerEvents(inbandEvents);\n        triggerEvents(inlineEvents);\n        removeEvents();\n    }\n\n    function refreshManifest() {\n        var manifest = manifestModel.getValue();\n        var url = manifest.url;\n\n        if (manifest.hasOwnProperty('Location')) {\n            url = manifest.Location;\n        }\n        log('Refresh manifest @ ' + url);\n        manifestUpdater.getManifestLoader().load(url);\n    }\n\n    function triggerEvents(events) {\n        var currentVideoTime = playbackController.getTime();\n        var presentationTime;\n\n        /* == Trigger events that are ready == */\n        if (events) {\n            var eventIds = Object.keys(events);\n            for (var i = 0; i < eventIds.length; i++) {\n                var eventId = eventIds[i];\n                var curr = events[eventId];\n\n                if (curr !== undefined) {\n                    presentationTime = curr.presentationTime / curr.eventStream.timescale;\n                    if (presentationTime === 0 || (presentationTime <= currentVideoTime && presentationTime + presentationTimeThreshold > currentVideoTime)) {\n                        log('Start Event ' + eventId + ' at ' + currentVideoTime);\n                        if (curr.duration > 0) {\n                            activeEvents[eventId] = curr;\n                        }\n                        if (curr.eventStream.schemeIdUri == MPD_RELOAD_SCHEME && curr.eventStream.value == MPD_RELOAD_VALUE) {\n                            refreshManifest();\n                        } else {\n                            eventBus.trigger(curr.eventStream.schemeIdUri, {event: curr});\n                        }\n                        delete events[eventId];\n                    }\n                }\n            }\n        }\n    }\n\n    function setConfig(config) {\n        if (!config) return;\n\n        if (config.manifestModel) {\n            manifestModel = config.manifestModel;\n        }\n\n        if (config.manifestUpdater) {\n            manifestUpdater = config.manifestUpdater;\n        }\n    }\n\n    function reset() {\n        clear();\n        inlineEvents = null;\n        inbandEvents = null;\n        activeEvents = null;\n        playbackController = null;\n    }\n\n    instance = {\n        initialize: initialize,\n        addInlineEvents: addInlineEvents,\n        addInbandEvents: addInbandEvents,\n        clear: clear,\n        start: start,\n        setConfig: setConfig,\n        reset: reset\n    };\n\n    return instance;\n}\n\nEventController.__dashjs_factory_name = 'EventController';\nexport default FactoryMaker.getSingletonFactory(EventController);\n"]}