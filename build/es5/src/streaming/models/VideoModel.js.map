{"version":3,"sources":["../../../../../src/streaming/models/VideoModel.js"],"names":[],"mappings":"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","file":"VideoModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport FactoryMaker from '../../core/FactoryMaker';\n\nfunction VideoModel() {\n\n    let instance,\n        element,\n        TTMLRenderingDiv,\n        videoContainer,\n        stalledStreams,\n        previousPlaybackRate;\n\n    function initialize() {\n        stalledStreams = [];\n    }\n\n    function onPlaybackCanPlay() {\n        element.playbackRate = previousPlaybackRate || 1;\n        element.removeEventListener('canplay', onPlaybackCanPlay);\n    }\n\n    function setPlaybackRate(value) {\n        if (!element) return;\n        if (element.readyState <= 2 && value > 0) {\n            // If media element hasn't loaded enough data to play yet, wait until it has\n            element.addEventListener('canplay', onPlaybackCanPlay);\n        } else {\n            element.playbackRate = value;\n        }\n    }\n\n    //TODO Move the DVR window calculations from MediaPlayer to Here.\n    function setCurrentTime(currentTime) {\n        //_currentTime = currentTime;\n\n        // We don't set the same currentTime because it can cause firing unexpected Pause event in IE11\n        // providing playbackRate property equals to zero.\n        if (element.currentTime == currentTime) return;\n\n        // TODO Despite the fact that MediaSource 'open' event has been fired IE11 cannot set videoElement.currentTime\n        // immediately (it throws InvalidStateError). It seems that this is related to videoElement.readyState property\n        // Initially it is 0, but soon after 'open' event it goes to 1 and setting currentTime is allowed. Chrome allows to\n        // set currentTime even if readyState = 0.\n        // setTimeout is used to workaround InvalidStateError in IE11\n        try {\n            element.currentTime = currentTime;\n        } catch (e) {\n            if (element.readyState === 0 && e.code === e.INVALID_STATE_ERR) {\n                setTimeout(function () {\n                    element.currentTime = currentTime;\n                }, 400);\n            }\n        }\n    }\n\n    function getElement() {\n        return element;\n    }\n\n    function setElement(value) {\n        element = value;\n        // Workaround to force Firefox to fire the canplay event.\n        element.preload = 'auto';\n    }\n\n    function setSource(source) {\n        if (source) {\n            element.src = source;\n        } else {\n            element.removeAttribute('src');\n            element.load();\n        }\n    }\n\n    function getSource() {\n        return element.src;\n    }\n\n    function getVideoContainer() {\n        return videoContainer;\n    }\n\n    function setVideoContainer(value) {\n        videoContainer = value;\n    }\n\n    function getTTMLRenderingDiv() {\n        return TTMLRenderingDiv;\n    }\n\n    function setTTMLRenderingDiv(div) {\n        TTMLRenderingDiv = div;\n        // The styling will allow the captions to match the video window size and position.\n        TTMLRenderingDiv.style.position = 'absolute';\n        TTMLRenderingDiv.style.display = 'flex';\n        TTMLRenderingDiv.style.overflow = 'hidden';\n        TTMLRenderingDiv.style.pointerEvents = 'none';\n        TTMLRenderingDiv.style.top = 0;\n        TTMLRenderingDiv.style.left = 0;\n    }\n\n    function setStallState(type, state) {\n        stallStream(type, state);\n    }\n\n    function isStalled() {\n        return (stalledStreams.length > 0);\n    }\n\n    function addStalledStream(type) {\n\n        let event;\n\n        if (type === null || element.seeking || stalledStreams.indexOf(type) !== -1) {\n            return;\n        }\n\n        stalledStreams.push(type);\n        if (stalledStreams.length === 1) {\n            // Halt playback until nothing is stalled.\n            event = document.createEvent('Event');\n            event.initEvent('waiting', true, false);\n            previousPlaybackRate = element.playbackRate;\n            setPlaybackRate(0);\n            element.dispatchEvent(event);\n        }\n    }\n\n    function removeStalledStream(type) {\n        let index = stalledStreams.indexOf(type);\n        let event;\n\n        if (type === null) {\n            return;\n        }\n        if (index !== -1) {\n            stalledStreams.splice(index, 1);\n        }\n        // If nothing is stalled resume playback.\n        if (isStalled() === false && element.playbackRate === 0) {\n            setPlaybackRate(previousPlaybackRate || 1);\n            if (!element.paused) {\n                event = document.createEvent('Event');\n                event.initEvent('playing', true, false);\n                element.dispatchEvent(event);\n            }\n        }\n    }\n\n    function stallStream(type, isStalled) {\n        if (isStalled) {\n            addStalledStream(type);\n        } else {\n            removeStalledStream(type);\n        }\n    }\n\n    function getPlaybackQuality() {\n        let hasWebKit = ('webkitDroppedFrameCount' in element) && ('webkitDecodedFrameCount' in element);\n        let hasQuality = ('getVideoPlaybackQuality' in element);\n        let result = null;\n\n        if (hasQuality) {\n            result = element.getVideoPlaybackQuality();\n        }\n        else if (hasWebKit) {\n            result = {\n                droppedVideoFrames: element.webkitDroppedFrameCount,\n                totalVideoFrames: element.webkitDroppedFrameCount + element.webkitDecodedFrameCount,\n                creationTime: new Date()\n            };\n        }\n\n        return result;\n    }\n\n    instance = {\n        initialize: initialize,\n        setCurrentTime: setCurrentTime,\n        setStallState: setStallState,\n        getElement: getElement,\n        setElement: setElement,\n        setSource: setSource,\n        getSource: getSource,\n        getVideoContainer: getVideoContainer,\n        setVideoContainer: setVideoContainer,\n        getTTMLRenderingDiv: getTTMLRenderingDiv,\n        setTTMLRenderingDiv: setTTMLRenderingDiv,\n        getPlaybackQuality: getPlaybackQuality\n    };\n\n    return instance;\n}\n\nVideoModel.__dashjs_factory_name = 'VideoModel';\nexport default FactoryMaker.getSingletonFactory(VideoModel);\n"]}