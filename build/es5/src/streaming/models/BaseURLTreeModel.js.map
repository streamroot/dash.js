{"version":3,"sources":["../../../../../src/streaming/models/BaseURLTreeModel.js"],"names":[],"mappings":"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","file":"BaseURLTreeModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport DashManifestModel from '../../dash/models/DashManifestModel';\nimport ObjectUtils from '../utils/ObjectUtils';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nconst DEFAULT_INDEX = NaN;\n\nclass Node {\n    constructor(_baseUrls, _selectedIdx) {\n        this.data = {\n            baseUrls: _baseUrls || null,\n            selectedIdx: _selectedIdx || DEFAULT_INDEX\n        };\n        this.children = [];\n    }\n}\n\nfunction BaseURLTreeModel() {\n\n    let instance;\n    let root;\n\n    const context = this.context;\n    const dashManifestModel = DashManifestModel(context).getInstance();\n    const objectUtils = ObjectUtils(context).getInstance();\n\n    function setup() {\n        root = new Node();\n    }\n\n    function updateChildData(node, index, element) {\n        let baseUrls = dashManifestModel.getBaseURLsFromElement(element);\n\n        if (!node[index]) {\n            node[index] = new Node(baseUrls);\n        } else {\n            if (!objectUtils.areSimpleEquivalent(baseUrls, node[index].data.baseUrls)) {\n                node[index].data.baseUrls = baseUrls;\n                node[index].data.selectedIdx = DEFAULT_INDEX;\n            }\n        }\n    }\n\n    function getBaseURLCollectionsFromManifest(manifest) {\n        let baseUrls = dashManifestModel.getBaseURLsFromElement(manifest);\n\n        if (!objectUtils.areSimpleEquivalent(baseUrls, root.data.baseUrls)) {\n            root.data.baseUrls = baseUrls;\n            root.data.selectedIdx = DEFAULT_INDEX;\n        }\n\n        if (manifest.Period_asArray) {\n            manifest.Period_asArray.forEach((p, pi) => {\n                updateChildData(root.children, pi, p);\n\n                if (p.AdaptationSet_asArray) {\n                    p.AdaptationSet_asArray.forEach((a, ai) => {\n                        updateChildData(root.children[pi].children, ai, a);\n\n                        if (a.Representation_asArray) {\n                            a.Representation_asArray.sort(\n                                dashManifestModel.getRepresentationSortFunction()\n                            ).forEach((r, ri) => {\n                                updateChildData(\n                                    root.children[pi].children[ai].children,\n                                    ri,\n                                    r\n                                );\n                            });\n                        }\n                    });\n                }\n            });\n        }\n    }\n\n    function walk(callback, node) {\n        var target = node || root;\n\n        callback(target.data);\n\n        if (target.children) {\n            target.children.forEach(child => walk(callback, child));\n        }\n    }\n\n    function invalidateSelectedIndexes(serviceLocation) {\n        walk((data) => {\n            if (!isNaN(data.selectedIdx)) {\n                if (serviceLocation === data.baseUrls[data.selectedIdx].serviceLocation) {\n                    data.selectedIdx = DEFAULT_INDEX;\n                }\n            }\n        });\n    }\n\n    function update(manifest) {\n        getBaseURLCollectionsFromManifest(manifest);\n    }\n\n    function reset() {\n        root = new Node();\n    }\n\n    function getForPath(path) {\n        var target = root;\n        var nodes = [target.data];\n\n        path.forEach(p => {\n            target = target.children[p];\n\n            if (target) {\n                nodes.push(target.data);\n            }\n        });\n\n        return nodes.filter(n => n.baseUrls.length);\n    }\n\n    instance = {\n        reset: reset,\n        update: update,\n        getForPath: getForPath,\n        invalidateSelectedIndexes: invalidateSelectedIndexes\n    };\n\n    setup();\n\n    return instance;\n}\n\nBaseURLTreeModel.__dashjs_factory_name = 'BaseURLTreeModel';\nexport default FactoryMaker.getClassFactory(BaseURLTreeModel);\n"]}