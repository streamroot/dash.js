{"version":3,"sources":["../../../../../../src/streaming/rules/abr/SwitchHistoryRule.js"],"names":[],"mappings":";;;;;;;;kCACyB,+BAA+B;;;;yBACtC,qBAAqB;;;;+BACb,qBAAqB;;;;AAE/C,SAAS,iBAAiB,GAAG;AACzB,QAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;AAC7B,QAAM,GAAG,GAAG,4BAAM,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC,GAAG,CAAC;;;AAG7C,QAAM,UAAU,GAAG,KAAK,CAAC;;;;AAIzB,QAAM,WAAW,GAAG,CAAC,CAAC;;AAGtB,aAAS,WAAW,CAAC,YAAY,EAAE;AAC/B,YAAM,oBAAoB,GAAG,YAAY,CAAC,gBAAgB,EAAE,CAAC;AAC7D,YAAI,cAAc,GAAG,oBAAoB,CAAC,iBAAiB,EAAE,CAAC;AAC9D,YAAI,KAAK,GAAG,CAAC,CAAC;AACd,YAAI,OAAO,GAAG,CAAC,CAAC;AAChB,YAAI,QAAQ,GAAG,CAAC,CAAC;AACjB,YAAI,aAAa,GAAG,kCAAc,OAAO,CAAC,CAAC,MAAM,EAAE,CAAC;;AAEpD,aAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAC5C,gBAAI,cAAc,CAAC,CAAC,CAAC,KAAK,SAAS,EAAE;AACjC,qBAAK,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;AACjC,uBAAO,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;AACrC,wBAAQ,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;;AAEvC,oBAAI,KAAK,GAAG,OAAO,IAAI,WAAW,IAAK,KAAK,GAAG,OAAO,GAAG,UAAU,AAAC,EAAE;AAClE,iCAAa,CAAC,KAAK,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACxC,iCAAa,CAAC,MAAM,GAAG,EAAC,KAAK,EAAE,aAAa,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE,QAAQ,EAAE,QAAQ,EAAC,CAAC;AACxG,uBAAG,CAAC,6BAA6B,GAAG,aAAa,CAAC,KAAK,GAAG,YAAY,IAAI,KAAK,GAAG,OAAO,CAAA,AAAC,GAAG,UAAU,GAAG,KAAK,CAAC,CAAC;AACjH,0BAAM;iBACT;aACJ;SACJ;;AAED,eAAO,aAAa,CAAC;KACxB;;AAED,WAAO;AACH,mBAAW,EAAE,WAAW;KAC3B,CAAC;CACL;;AAGD,iBAAiB,CAAC,qBAAqB,GAAG,eAAe,CAAC;AAC1D,IAAI,OAAO,GAAG,gCAAa,eAAe,CAAC,iBAAiB,CAAC,CAAC;;qBAE/C,OAAO","file":"SwitchHistoryRule.js","sourcesContent":["\nimport FactoryMaker from '../../../core/FactoryMaker.js';\nimport Debug from '../../../core/Debug';\nimport SwitchRequest from '../SwitchRequest.js';\n\nfunction SwitchHistoryRule() {\n    const context = this.context;\n    const log = Debug(context).getInstance().log;\n\n    //MAX_SWITCH is the number of drops made. It doesn't consider the size of the drop.\n    const MAX_SWITCH = 0.075;\n\n    //Before this number of switch requests(no switch or actual), don't apply the rule.\n    //must be < SwitchRequestHistory SWITCH_REQUEST_HISTORY_DEPTH to enable rule\n    const SAMPLE_SIZE = 6;\n\n\n    function getMaxIndex(rulesContext) {\n        const switchRequestHistory = rulesContext.getSwitchHistory();\n        let switchRequests = switchRequestHistory.getSwitchRequests();\n        let drops = 0;\n        let noDrops = 0;\n        let dropSize = 0;\n        let switchRequest = SwitchRequest(context).create();\n\n        for (let i = 0; i < switchRequests.length; i++) {\n            if (switchRequests[i] !== undefined) {\n                drops += switchRequests[i].drops;\n                noDrops += switchRequests[i].noDrops;\n                dropSize += switchRequests[i].dropSize;\n\n                if (drops + noDrops >= SAMPLE_SIZE && (drops / noDrops > MAX_SWITCH)) {\n                    switchRequest.value = i > 0 ? i - 1 : 0;\n                    switchRequest.reason = {index: switchRequest.value, drops: drops, noDrops: noDrops, dropSize: dropSize};\n                    log('Switch history rule index: ' + switchRequest.value + ' samples: ' + (drops + noDrops) + ' drops: ' + drops);\n                    break;\n                }\n            }\n        }\n\n        return switchRequest;\n    }\n\n    return {\n        getMaxIndex: getMaxIndex\n    };\n}\n\n\nSwitchHistoryRule.__dashjs_factory_name = 'SwitchRequest';\nlet factory = FactoryMaker.getClassFactory(SwitchHistoryRule);\n\nexport default factory;"]}