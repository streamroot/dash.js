{"version":3,"sources":["../../../../../src/streaming/text/TextController.js"],"names":[],"mappings":"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","file":"TextController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport TextSourceBuffer from './TextSourceBuffer';\nimport TextTracks from './TextTracks';\nimport VTTParser from '../utils/VTTParser';\nimport TTMLParser from '../utils/TTMLParser';\n\nfunction TextController() {\n\n    let context = this.context;\n    let instance;\n    let textSourceBuffer;\n\n    let allTracksAreDisabled,\n        errHandler,\n        dashManifestModel,\n        mediaController,\n        videoModel,\n        streamController,\n        textTracks,\n        vttParser,\n        ttmlParser;\n\n    function setup() {\n\n        textTracks = TextTracks(context).getInstance();\n        vttParser = VTTParser(context).getInstance();\n        ttmlParser = TTMLParser(context).getInstance();\n        textSourceBuffer = TextSourceBuffer(context).getInstance();\n\n        textTracks.initialize();\n        allTracksAreDisabled = false;\n    }\n\n    function setConfig(config) {\n        if (!config) {\n            return;\n        }\n        if (config.errHandler) {\n            errHandler = config.errHandler;\n        }\n        if (config.dashManifestModel) {\n            dashManifestModel = config.dashManifestModel;\n        }\n        if (config.mediaController) {\n            mediaController = config.mediaController;\n        }\n        if (config.videoModel) {\n            videoModel = config.videoModel;\n        }\n        if (config.streamController) {\n            streamController = config.streamController;\n        }\n        if (config.textTracks) {\n            textTracks = config.textTracks;\n        }\n        if (config.vttParser) {\n            vttParser = config.vttParser;\n        }\n        if (config.ttmlParser) {\n            ttmlParser = config.ttmlParser;\n        }\n\n        // create config for source buffer\n        textSourceBuffer.setConfig({\n            errHandler: errHandler,\n            dashManifestModel: dashManifestModel,\n            mediaController: mediaController,\n            videoModel: videoModel,\n            streamController: streamController,\n            textTracks: textTracks,\n            vttParser: vttParser,\n            ttmlParser: ttmlParser\n        });\n    }\n\n    function getTextSourceBuffer() {\n        return textSourceBuffer;\n    }\n\n    function getAllTracksAreDisabled() {\n        return allTracksAreDisabled;\n    }\n\n    function addEmbeddedTrack(mediaInfo) {\n        textSourceBuffer.addEmbeddedTrack(mediaInfo);\n    }\n\n    function setTextTrack() {\n\n        var config = textSourceBuffer.getConfig();\n        var fragmentModel = config.fragmentModel;\n        var embeddedTracks = config.embeddedTracks;\n        var isFragmented = config.isFragmented;\n        var fragmentedTracks = config.fragmentedTracks;\n        var allTracksAreDisabled = config.allTracksAreDisabled;\n\n        var el = videoModel.getElement();\n        var tracks = el.textTracks;\n        var ln = tracks.length;\n        var nrNonEmbeddedTracks = ln - embeddedTracks.length;\n        var oldTrackIdx = textTracks.getCurrentTrackIdx();\n\n        for (var i = 0; i < ln; i++) {\n            var track = tracks[i];\n            allTracksAreDisabled = track.mode !== 'showing';\n            if (track.mode === 'showing') {\n                if (oldTrackIdx !== i) { // do not reset track if already the current track.  This happens when all captions get turned off via UI and then turned on again and with videojs.\n                    textTracks.setCurrentTrackIdx(i);\n                    textTracks.addCaptions(i, 0, null); // Make sure that previously queued captions are added as cues\n\n                    // specific to fragmented texe\n                    if (isFragmented && i < nrNonEmbeddedTracks) {\n                        var currentFragTrack = mediaController.getCurrentTrackFor('fragmentedText', streamController.getActiveStreamInfo());\n                        var newFragTrack = fragmentedTracks[i];\n                        if (newFragTrack !== currentFragTrack) {\n                            fragmentModel.abortRequests();\n                            textTracks.deleteTrackCues(currentFragTrack);\n                            mediaController.setTrack(newFragTrack);\n                            textSourceBuffer.setCurrentFragmentedTrackIdx(i);\n                        }\n                    }\n                }\n                break;\n            }\n        }\n\n        if (allTracksAreDisabled) {\n            textTracks.setCurrentTrackIdx(-1);\n        }\n    }\n\n    function getCurrentTrackIdx() {\n        var textTracks = textSourceBuffer.getConfig().textTracks;\n        return textTracks.getCurrentTrackIdx();\n    }\n\n    function reset() {\n        allTracksAreDisabled = false;\n        textSourceBuffer.resetEmbedded();\n    }\n\n    instance = {\n        setConfig: setConfig,\n        getTextSourceBuffer: getTextSourceBuffer,\n        getAllTracksAreDisabled: getAllTracksAreDisabled,\n        addEmbeddedTrack: addEmbeddedTrack,\n        setTextTrack: setTextTrack,\n        getCurrentTrackIdx: getCurrentTrackIdx,\n        reset: reset\n    };\n    setup();\n    return instance;\n}\n\nTextController.__dashjs_factory_name = 'TextController';\nexport default FactoryMaker.getSingletonFactory(TextController);\n"]}