{"version":3,"sources":["../../../../../src/streaming/utils/DOMStorage.js"],"names":[],"mappings":"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","file":"DOMStorage.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport MediaPlayerModel from '../models/MediaPlayerModel';\nimport Debug from '../../core/Debug';\n\nconst legacyKeysAndReplacements = [\n    { oldKey: 'dashjs_vbitrate',  newKey: 'dashjs_video_bitrate' },\n    { oldKey: 'dashjs_abitrate',  newKey: 'dashjs_audio_bitrate' },\n    { oldKey: 'dashjs_vsettings', newKey: 'dashjs_video_settings' },\n    { oldKey: 'dashjs_asettings', newKey: 'dashjs_audio_settings' }\n];\n\nconst LOCAL_STORAGE_BITRATE_KEY_TEMPLATE = 'dashjs_?_bitrate';\nconst LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE = 'dashjs_?_settings';\n\nconst STORAGE_TYPE_LOCAL = 'localStorage';\nconst STORAGE_TYPE_SESSION = 'sessionStorage';\n\nfunction DOMStorage() {\n\n    let context = this.context;\n    let log = Debug(context).getInstance().log;\n\n    let instance,\n        supported,\n        mediaPlayerModel;\n\n    //type can be local, session\n    function isSupported(type) {\n        if (supported !== undefined) return supported;\n\n        supported = false;\n\n        var testKey = '1';\n        var testValue = '1';\n        var storage;\n\n        try {\n            if (typeof window !== 'undefined') {\n                storage = window[type];\n            }\n        } catch (error) {\n            log('Warning: DOMStorage access denied: ' + error.message);\n            return supported;\n        }\n\n        if (!storage || (type !== STORAGE_TYPE_LOCAL && type !== STORAGE_TYPE_SESSION)) {\n            return supported;\n        }\n\n        /* When Safari (OS X or iOS) is in private browsing mode, it appears as though localStorage is available, but trying to call setItem throws an exception.\n         http://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an\n\n         Check if the storage can be used\n         */\n        try {\n            storage.setItem(testKey, testValue);\n            storage.removeItem(testKey);\n            supported = true;\n        } catch (error) {\n            log('Warning: DOMStorage is supported, but cannot be used: ' + error.message);\n        }\n\n        return supported;\n    }\n\n    function translateLegacyKeys() {\n        if (isSupported(STORAGE_TYPE_LOCAL)) {\n            legacyKeysAndReplacements.forEach(entry => {\n                const value = localStorage.getItem(entry.oldKey);\n\n                if (value) {\n                    localStorage.removeItem(entry.oldKey);\n\n                    try {\n                        localStorage.setItem(entry.newKey, value);\n                    } catch (e) {\n                        log(e.message);\n                    }\n                }\n            });\n        }\n    }\n\n    function setup() {\n        mediaPlayerModel = MediaPlayerModel(context).getInstance();\n\n        translateLegacyKeys();\n    }\n\n    // Return current epoch time, ms, rounded to the nearest 10m to avoid fingerprinting user\n    function getTimestamp() {\n        let ten_minutes_ms = 60 * 1000 * 10;\n        return Math.round(new Date().getTime() / ten_minutes_ms) * ten_minutes_ms;\n    }\n\n    function canStore(storageType, key) {\n        return isSupported(storageType) && mediaPlayerModel['get' + key + 'CachingInfo']().enabled;\n    }\n\n    function getSavedMediaSettings(type) {\n        //Checks local storage to see if there is valid, non-expired media settings\n        if (!canStore(STORAGE_TYPE_LOCAL, 'LastMediaSettings')) return null;\n\n        var key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n        var obj = JSON.parse(localStorage.getItem(key)) || {};\n        var isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastMediaSettingsCachingInfo().ttl || false;\n        var settings = obj.settings;\n\n        if (isExpired) {\n            localStorage.removeItem(key);\n            settings = null;\n        }\n\n        return settings;\n    }\n\n    function getSavedBitrateSettings(type) {\n        let savedBitrate = NaN;\n        //Checks local storage to see if there is valid, non-expired bit rate\n        //hinting from the last play session to use as a starting bit rate.\n        if (canStore(STORAGE_TYPE_LOCAL, 'LastBitrate')) {\n            var key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            var obj = JSON.parse(localStorage.getItem(key)) || {};\n            var isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastBitrateCachingInfo().ttl || false;\n            var bitrate = parseInt(obj.bitrate, 10);\n\n            if (!isNaN(bitrate) && !isExpired) {\n                savedBitrate = bitrate;\n                log('Last saved bitrate for ' + type + ' was ' + bitrate);\n            } else if (isExpired) {\n                localStorage.removeItem(key);\n            }\n        }\n        return savedBitrate;\n    }\n\n    function setSavedMediaSettings(type, value) {\n        if (canStore(STORAGE_TYPE_LOCAL, 'LastMediaSettings')) {\n            let key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({settings: value, timestamp: getTimestamp()}));\n            } catch (e) {\n                log(e.message);\n            }\n        }\n    }\n\n    function setSavedBitrateSettings(type, bitrate) {\n        if (canStore(STORAGE_TYPE_LOCAL, 'LastBitrate') && bitrate) {\n            let key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({bitrate: bitrate / 1000, timestamp: getTimestamp()}));\n            } catch (e) {\n                log(e.message);\n            }\n        }\n    }\n\n    instance = {\n        getSavedBitrateSettings: getSavedBitrateSettings,\n        setSavedBitrateSettings: setSavedBitrateSettings,\n        getSavedMediaSettings: getSavedMediaSettings,\n        setSavedMediaSettings: setSavedMediaSettings,\n        isSupported: isSupported\n    };\n\n    setup();\n    return instance;\n}\n\nDOMStorage.__dashjs_factory_name = 'DOMStorage';\nlet factory = FactoryMaker.getSingletonFactory(DOMStorage);\nexport default factory;\n"]}