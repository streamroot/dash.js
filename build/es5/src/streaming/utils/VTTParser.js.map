{"version":3,"sources":["../../../../../src/streaming/utils/VTTParser.js"],"names":[],"mappings":"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","file":"VTTParser.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\n\nfunction VTTParser() {\n    let context = this.context;\n    let log = Debug(context).getInstance().log;\n\n    let instance,\n        regExNewLine,\n        regExToken,\n        regExWhiteSpace,\n        regExWhiteSpaceWordBoundary;\n\n    function setup() {\n        regExNewLine = /(?:\\r\\n|\\r|\\n)/gm;\n        regExToken = /-->/;\n        regExWhiteSpace = /(^[\\s]+|[\\s]+$)/g;\n        regExWhiteSpaceWordBoundary = /\\s\\b/g;\n    }\n\n    function parse(data) {\n        var captionArray = [];\n        var len,\n            lastStartTime;\n\n        data = data.split( regExNewLine );\n        len = data.length;\n        lastStartTime = -1;\n\n        for (var i = 0 ; i < len; i++)\n        {\n            var item = data[i];\n\n            if (item.length > 0 && item !== 'WEBVTT')\n            {\n                if (item.match(regExToken))\n                {\n                    var attributes = parseItemAttributes(item);\n                    var cuePoints = attributes.cuePoints;\n                    var styles = attributes.styles;\n                    var text = getSublines(data, i + 1);\n                    var startTime = convertCuePointTimes(cuePoints[0].replace(regExWhiteSpace, ''));\n                    var endTime = convertCuePointTimes(cuePoints[1].replace(regExWhiteSpace, ''));\n\n                    if ((!isNaN(startTime) && !isNaN(endTime)) && startTime >= lastStartTime && endTime > startTime) {\n                        if (text !== '') {\n                            lastStartTime = startTime;\n                            //TODO Make VO external so other parsers can use.\n                            captionArray.push({\n                                start: startTime,\n                                end: endTime,\n                                data: text,\n                                styles: styles\n                            });\n                        }\n                        else {\n                            log('Skipping cue due to empty/malformed cue text');\n                        }\n                    }\n                    else {\n                        log('Skipping cue due to incorrect cue timing');\n                    }\n                }\n            }\n        }\n\n        return captionArray;\n    }\n\n    function convertCuePointTimes(time) {\n        var timeArray = time.split(':');\n        var len = timeArray.length - 1;\n\n        time = parseInt( timeArray[len - 1], 10 ) * 60 + parseFloat( timeArray[len]);\n\n        if ( len === 2 ) {\n            time += parseInt( timeArray[0], 10 ) * 3600;\n        }\n\n        return time;\n    }\n\n    function parseItemAttributes(data) {\n        var vttCuePoints = data.split(regExToken);\n        var arr = vttCuePoints[1].split(regExWhiteSpaceWordBoundary);\n        arr.shift(); //remove first array index it is empty...\n        vttCuePoints[1] = arr[0];\n        arr.shift();\n        return {cuePoints: vttCuePoints, styles: getCaptionStyles(arr)};\n    }\n\n    function getCaptionStyles(arr) {\n        var styleObject = {};\n        arr.forEach(function (element) {\n            if (element.split(/:/).length > 1) {\n                var val = element.split(/:/)[1];\n                if (val && val.search(/%/) != -1) {\n                    val = parseInt(val.replace(/%/, ''), 10);\n                }\n                if (element.match(/align/) || element.match(/A/)) {\n                    styleObject.align = val;\n                }\n                if (element.match(/line/) || element.match(/L/) ) {\n                    styleObject.line = val;\n                }\n                if (element.match(/position/) || element.match(/P/) ) {\n                    styleObject.position = val;\n                }\n                if (element.match(/size/) || element.match(/S/)) {\n                    styleObject.size = val;\n                }\n            }\n        });\n\n        return styleObject;\n    }\n\n    /*\n    * VTT can have multiple lines to display per cuepoint.\n    */\n    function getSublines(data, idx) {\n        var i = idx;\n\n        var subline = '';\n        var lineData = '';\n        var lineCount;\n\n        while (data[i] !== '' && i < data.length) {\n            i++;\n        }\n\n        lineCount = i - idx;\n        if (lineCount > 1) {\n            for (var j = 0; j < lineCount; j++) {\n                lineData = data[(idx + j)];\n                if (!lineData.match(regExToken)) {\n                    subline += lineData;\n                    if (j !== lineCount - 1) {\n                        subline += '\\n';\n                    }\n                }\n                else {\n                    // caption text should not have '-->' in it\n                    subline = '';\n                    break;\n                }\n            }\n        } else {\n            lineData = data[idx];\n            if (!lineData.match(regExToken))\n                subline = lineData;\n        }\n        return decodeURI(subline);\n    }\n\n    instance = {\n        parse: parse\n    };\n\n    setup();\n    return instance;\n}\nVTTParser.__dashjs_factory_name = 'VTTParser';\nexport default FactoryMaker.getSingletonFactory(VTTParser);\n"]}